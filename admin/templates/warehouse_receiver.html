{% extends "frontend_base.html" %}
{% load static %}

{% block title %}Warehouse Receiver{% endblock %}

{% block content %}
<style>
  @media(max-width:768px) {
    input[type='checkbox'] {
      width: 25px;
      height: 25px;
    }
    .product_item_class{
      margin-top: 10px;
    }
    .form-label{
      font-size: 16px;
    }
    .fw-bold{
      font-size: 16px;
    }
    .container-lg {
      padding-left: 5px;
      padding-right: 5px;
    }
    .card-body {
      padding: 10px 5px;
    }
    h3 {
      font-size: 20px;
    }
    h4 {
      font-size: 18px;
    }
    
    /* Table optimizations for mobile */
    .table-responsive {
      overflow-x: auto;
    }
    .table {
      font-size: 12px;
    }
    .table th, .table td {
      padding: 5px;
    }
    .table input {
      padding: 4px;
      font-size: 13px;
      height: 32px;
    }
    
    /* Button optimizations for mobile */
    .btn {
      padding: 6px 10px;
      font-size: 14px;
      margin-bottom: 8px;
      height: auto;
      white-space: normal;
    }
    .btn-lg {
      padding: 8px 12px;
      font-size: 14px;
    }
    
    /* Stack buttons on mobile */
    .text-center .gap-3 {
      flex-direction: column;
      width: 100%;
    }
    .text-center .gap-3 .btn, 
    .text-center .gap-3 a.btn {
      width: 100%;
      margin-bottom: 10px;
      margin-right: 0 !important;
      margin-left: 0 !important;
    }
  }

  /* General responsive improvements */
  .table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  input.form-control, select.form-control {
    height: 38px;
    font-size: 16px; /* Prevents iOS zoom on focus */
  }
  
  /* Auto-search loading indicator styles */
  .client-item.searching {
    background-image: url('data:image/gif;base64,R0lGODlhEAAQAPIAAP///wAAAMLCwkJCQgAAAGJiYoKCgpKSkiH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAEAAQAAADMwi63P4wyklrE2MIOggZnAdOmGYJRbExwroUmcG2LmDEwnHQLVsYOd2mBzkYDAdKa+dIAAAh+QQJCgAAACwAAAAAEAAQAAADNAi63P5OjCEgG4QMu7DmikRxQlFUYDEZIGBMRVsaqHwctXXf7WEYB4Ag1xjihkMZsiUkKhIAIfkECQoAAAAsAAAAABAAEAAAAzYIujIjK8pByJDMlFYvBoVjHA70GU7xSUJhmKtwHPAKzLO9HMaoKwJZ7Rf8AYPDDzKpZBqfvwQAIfkECQoAAAAsAAAAABAAEAAAAzMIumIlK8oyhpHsnFZfhYumCYUhDAQxRIdhHBGqRoKw0R8DYlJd8z0fMDgsGo/IpHI5TAAAIfkECQoAAAAsAAAAABAAEAAAAzIIunInK0rnZBTwGPNMgQwmdsNgXGJUlIWEuR5oWUIpz8pAEAMe6TwfwyYsGo/IpFKSAAAh+QQJCgAAACwAAAAAEAAQAAADMwi6IMKQORfjdOe82p4wGccc4CEuQradylesojEMBgsUc2G7sDX3lQGBMLAJibufbSlKAAAh+QQJCgAAACwAAAAAEAAQAAADMgi63P7wCRHZnFVdmgHu2nFwlWCI3WGc3TSWhUFGxTAUkGCbtgENBMJAEJsxgMLWzpEAACH5BAkKAAAALAAAAAAQABAAAAMyCLrc/jDKSatlQtScKdceCAjDII7HcQ4EMTCpyrCuUBjCYRgHVtqlAiB1YhiCnlsRkAAAOwAAAAAAAAAAAA==');
    background-position: right 10px center;
    background-repeat: no-repeat;
    background-size: 16px 16px;
    padding-right: 30px;
  }
</style>

<!-- Ensure Bootstrap JS is loaded -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" defer></script>

<div class="container-lg my-5">
  <!-- First Card: Receiving Form -->
  <div class="card shadow-sm rounded-4 mb-4">
    <div class="card-body p-4">
      <h3 class="mb-2 text-center text-secondary py-4">Warehouse Receiver</h3>
      <h4 class="mb-4 text-secondary">Received Shipment</h4>
      
      <form method="post" action="{% url 'warehouse_receiver' %}" id="warehouse-receiver-form">
        {% csrf_token %}
        
        <!-- Reference ID -->
        <div class="row mb-4">
          <div class="col-md-6">
            <label class="form-label">Reference ID</label>
            <input type="text" class="form-control" name="reference_id" id="reference_id" placeholder="Enter Reference ID" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Received Date</label>
            <input type="date" class="form-control" name="received_date" id="received_date" required>
          </div>
        </div>
        
        <!-- Items Section -->
        <div class="row mb-4">
          <div class="col-12">
            <h5 class="mb-3">Items</h5>
            
            <div id="items-container">
              <!-- Template for item row -->
              <div class="row mb-3 item-row">
                <div class="col-md-4">
                  <label class="form-label">Client Item #</label>
                  <input type="text" class="form-control client-item" name="client_items[]" placeholder="Enter Client Item #" required>
                </div>
                <div class="col-md-5">
                  <label class="form-label">Product Name</label>
                  <input type="text" class="form-control product-name" name="product_names[]" placeholder="Product Name" readonly>
                </div>
                <div class="col-md-2">
                  <label class="form-label">Quantity</label>
                  <input type="number" class="form-control" name="quantities[]" min="1" value="1" required>
                </div>
                <div class="col-md-1">
                  <label class="form-label d-md-block d-none">&nbsp;</label>
                  <button type="button" class="btn btn-danger remove-item">
                    <span class="material-icons">delete</span>
                  </button>
                </div>
              </div>
            </div>
            
            <div class="text-center mt-3">
              <button type="button" class="btn btn-secondary" id="add-item-btn">
                <span class="material-icons align-middle">add</span> Add Another Item
              </button>
            </div>
          </div>
        </div>
        
        <div class="text-center mt-4">
          <div class="d-inline-flex gap-3">
            <button type="button" class="btn btn-outline-secondary mr-3" id="clear-form-btn">Cancel / Clear Form</button>
            <button type="submit" class="btn btn-secondary btn-lg">Submit</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Second Card: Previous Receipts -->
  <div class="card shadow-sm rounded-4">
    <div class="card-body p-4">
      <h4 class="mb-3">Previous Warehouse Receipts</h4>
      
      <!-- Lazy loading spinner - shown while loading -->
      <div id="receipts-loading" class="text-center py-4">
        <div class="spinner-border text-secondary" role="status">
        </div>
      </div>
      
      <!-- Content loaded via AJAX -->
      <div id="receipts-container" class="d-none">
        <div class="row">
          <div class="col-12">
            <div class="table-responsive">
              <table class="table table-bordered table-striped">
                <thead>
                  <tr>
                    <th>Reference ID</th>
                    <th>Received Date</th>
                    <th>Items Count</th>
                    <th>Total Quantity</th>
                    <th>Received By</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="receipts-table-body">
                  <!-- Will be populated via JavaScript -->
                </tbody>
              </table>
            </div>
            
            <nav id="pagination-container" class="mt-3">
              <ul class="pagination justify-content-center">
                <!-- Will be populated via JavaScript -->
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Receipt Details Modal -->
<div class="modal fade" id="receiptDetailsModal" tabindex="-1" aria-labelledby="receiptDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="receiptDetailsModalLabel">Receipt Details</h5>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <p><strong>Reference ID:</strong> <span id="modal-reference-id"></span></p>
            <p><strong>Received Date:</strong> <span id="modal-received-date"></span></p>
          </div>
          <div class="col-md-6">
            <p><strong>Received By:</strong> <span id="modal-received-by"></span></p>
          </div>
        </div>
        
        <h6 class="mt-4 mb-3">Items</h6>
        <div class="table-responsive">
          <table class="table table-sm table-bordered">
            <thead>
              <tr>
                <th>Client Item #</th>
                <th>Product Name</th>
                <th>Quantity</th>
              </tr>
            </thead>
            <tbody id="modal-items-list">
              <!-- Items will be populated dynamically -->
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="$('#receiptDetailsModal').modal('hide');">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  $(document).ready(function() {
    // Make sure Bootstrap JS is properly loaded and initialized
    if (typeof bootstrap !== 'undefined') {
      console.log('Bootstrap is loaded');
    } else {
      console.log('Bootstrap is not loaded properly');
      // Load Bootstrap JS dynamically if not available
      const bootstrapScript = document.createElement('script');
      bootstrapScript.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js';
      document.head.appendChild(bootstrapScript);
    }

    // Add explicit handler for modal close button
    $('.btn-close, [data-bs-dismiss="modal"]').on('click', function() {
      $('#receiptDetailsModal').modal('hide');
    });
    
    // Set current date for received date field
    const today = new Date().toISOString().split('T')[0];
    $('#received_date').val(today);
    
    // Add new item row
    $('#add-item-btn').on('click', function() {
      const newRow = $('#items-container .item-row').first().clone();
      newRow.find('input').val(''); // Clear input values
      newRow.find('input[name="quantities[]"]').val(1); // Reset quantity to 1
      $('#items-container').append(newRow);
    });
    
    // Remove item row (using event delegation for dynamically added elements)
    $('#items-container').on('click', '.remove-item', function() {
      // Only remove if there's more than one item row
      if ($('#items-container .item-row').length > 1) {
        $(this).closest('.item-row').remove();
      } else {
        toastr.warning('You must have at least one item.');
      }
    });
    
    // Clear form button
    $('#clear-form-btn').on('click', function() {
      // Reset the form
      $('#warehouse-receiver-form')[0].reset();
      
      // Set current date again
      $('#received_date').val(today);
      
      // Keep only one item row
      const firstRow = $('#items-container .item-row').first();
      $('#items-container .item-row').not(firstRow).remove();
      firstRow.find('input').val('');
      firstRow.find('input[name="quantities[]"]').val(1);
      
      toastr.info('Form has been cleared.');
    });
    
    // Variable to store timeout for auto-search
    let searchTimeout;
    
    // Auto-search after typing stops for 3 seconds
    $('#items-container').on('input', '.client-item', function() {
      const row = $(this).closest('.item-row');
      const clientItem = $(this).val().trim();
      const $input = $(this); // Store input element reference
      
      // Clear any existing timeout
      clearTimeout(searchTimeout);
      
      // Remove searching class initially
      $input.removeClass('searching');
      
      if (clientItem) {
        // Add searching class to show we're waiting
        $input.addClass('searching');
        
        // Set a new timeout for 3 seconds
        searchTimeout = setTimeout(function() {
          // Trigger product search
          if (clientItem) {
            // Make AJAX request to get product details
            $.ajax({
              url: "{% url 'get_product_item_num' %}",
              type: "GET",
              data: { room_number: clientItem },
              success: function(data) {
                // Remove searching class when done
                $input.removeClass('searching');
                
                if (data.success) {
                  // Fill product name
                  row.find('.product-name').val(data.product_name || data.room_type);
                  toastr.success('Product found');
                } else {
                  row.find('.product-name').val('');
                  // Don't show error toast on auto-search
                }
              },
              error: function() {
                // Remove searching class when done
                $input.removeClass('searching');
                // Don't show error toast on auto-search
              }
            });
          }
        }, 3000); // 3 seconds delay
      }
    });
    
    // Initialize toastr options
    toastr.options = {
      "closeButton": true,
      "progressBar": true,
      "timeOut": "3000"
    };
    
    // Load previous receipts via AJAX
    let currentPage = 1;
    
    function loadReceipts(page = 1) {
      // Show loading indicator
      $('#receipts-loading').removeClass('d-none');
      $('#receipts-container').addClass('d-none');
      
      // Make AJAX request to get receipts
      $.ajax({
        url: "{% url 'get_warehouse_receipts' %}",
        type: "GET",
        data: { page: page },
        success: function(data) {
          if (data.success) {
            // Update current page
            currentPage = data.page;
            
            // Populate table with receipts
            const tableBody = $('#receipts-table-body');
            tableBody.empty();
            
            if (data.receipts.length === 0) {
              tableBody.append(`
                <tr>
                  <td colspan="6" class="text-center">No previous receipts found.</td>
                </tr>
              `);
            } else {
              data.receipts.forEach(function(receipt) {
                tableBody.append(`
                  <tr>
                    <td>${receipt.reference_id}</td>
                    <td>${receipt.received_date}</td>
                    <td>${receipt.items_count}</td>
                    <td>${receipt.total_quantity}</td>
                    <td>${receipt.received_by}</td>
                    <td>
                      <button type="button" class="btn btn-secondary btn-sm view-details" data-id="${receipt.id}">View Details</button>
                    </td>
                  </tr>
                `);
              });
            }
            
            // Update pagination
            const paginationContainer = $('#pagination-container ul');
            paginationContainer.empty();
            
            // Previous button
            if (data.has_previous) {
              paginationContainer.append(`
                <li class="page-item">
                  <a class="page-link page-nav" href="#" data-page="${data.previous_page}">Previous</a>
                </li>
              `);
            }
            
            // Page numbers
            for (let num = 1; num <= data.total_pages; num++) {
              if (num === data.page) {
                paginationContainer.append(`
                  <li class="page-item active">
                    <span class="page-link">${num}</span>
                  </li>
                `);
              } else if (num <= 4 || num > data.total_pages - 3) {
                paginationContainer.append(`
                  <li class="page-item">
                    <a class="page-link page-nav" href="#" data-page="${num}">${num}</a>
                  </li>
                `);
              } else if (num === 5 && data.page > 7) {
                paginationContainer.append(`
                  <li class="page-item disabled">
                    <span class="page-link">...</span>
                  </li>
                `);
              } else if (num === data.total_pages - 4 && data.page < data.total_pages - 6) {
                paginationContainer.append(`
                  <li class="page-item disabled">
                    <span class="page-link">...</span>
                  </li>
                `);
              }
            }
            
            // Next button
            if (data.has_next) {
              paginationContainer.append(`
                <li class="page-item">
                  <a class="page-link page-nav" href="#" data-page="${data.next_page}">Next</a>
                </li>
              `);
            }
            
            // Show receipts container, hide loading indicator
            $('#receipts-loading').addClass('d-none');
            $('#receipts-container').removeClass('d-none');
            
            // Re-bind click handlers for view details buttons
            $('.view-details').on('click', function() {
              const receiptId = $(this).data('id');
              loadReceiptDetails(receiptId);
            });
          } else {
            // Show error
            toastr.error(data.message || 'Failed to load receipts');
            $('#receipts-loading').addClass('d-none');
          }
        },
        error: function() {
          toastr.error('Error loading receipts');
          $('#receipts-loading').addClass('d-none');
        }
      });
    }
    
    // Handle pagination clicks
    $(document).on('click', '.page-nav', function(e) {
      e.preventDefault();
      const page = $(this).data('page');
      loadReceipts(page);
    });
    
    // Function to load receipt details
    function loadReceiptDetails(receiptId) {
      // Make AJAX request to get receipt details
      $.ajax({
        url: "{% url 'get_warehouse_receipt_details' %}",
        type: "GET",
        data: { receipt_id: receiptId },
        success: function(data) {
          if (data.success) {
            // Populate modal with receipt details
            $('#modal-reference-id').text(data.receipt.reference_id);
            $('#modal-received-date').text(data.receipt.received_date);
            $('#modal-received-by').text(data.receipt.received_by);
            
            // Clear and populate items table
            const itemsList = $('#modal-items-list');
            itemsList.empty();
            
            data.items.forEach(function(item) {
              itemsList.append(`
                <tr>
                  <td>${item.client_id}</td>
                  <td>${item.product_name}</td>
                  <td>${item.quantity}</td>
                </tr>
              `);
            });
            
            // Show the modal
            $('#receiptDetailsModal').modal('show');
          } else {
            toastr.error(data.message || 'Failed to load receipt details');
          }
        },
        error: function() {
          toastr.error('Error loading receipt details');
        }
      });
    }
    
    // Load receipts when page loads
    loadReceipts();
    
    // Process Django messages with toastr
    // We use JS-safe approach to handle Django template tags
    var djangoMessages = [];
    {% if messages %}
      {% for message in messages %}
        djangoMessages.push({
          "tag": "{{ message.tags }}",
          "text": "{{ message|escapejs }}"
        });
      {% endfor %}
    {% endif %}
    
    // Process the messages with toastr
    djangoMessages.forEach(function(msg) {
      if (msg.tag === "success") {
        toastr.success(msg.text);
      } else if (msg.tag === "error") {
        toastr.error(msg.text);
      } else if (msg.tag === "warning") {
        toastr.warning(msg.text);
      } else if (msg.tag === "info") {
        toastr.info(msg.text);
      }
    });
  });
</script>
{% endblock %} 