{% extends "frontend_base.html" %}
{% load static %}

{% block title %}Installation Control Form{% endblock %}

{% block content %}
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
@media (max-width: 768px) {
  .border.border-light {
    border-radius: 11px !important;
    /* box-shadow: 14px 2px 17px 0px #ded8d8 !important; */

    box-shadow: rgba(50, 50, 93, 0.25) 0px 6px 12px -2px, rgba(0, 0, 0, 0.3) 0px 3px 7px -3px;
  }
  input[type='checkbox'] {
      width: 22px;
      height: 22px;
    }

    #search_room {
  height: 40px; /* Adjust the height as needed */
  font-size: 16px; /* Optional: to match other elements */
  padding: 5px 15px; /* Optional: control inner spacing */
}

}
.card{
  font-size: 16px; /* adjust as needed */
}
.form-control{
  font-size: 16px;

}

</style>
<div class="container-lg my-5">
    <div class="card shadow-sm rounded-4">
        <div class="card-body p-4">
            <h3 class="mb-4 text-center text-secondary py-4">Installation Control Form</h3>



            <form method="post">
                {% csrf_token %}

                <!-- Room Info -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="room_number" class="form-label" >Room #</label>
                        <div class="input-group">
                            <input type="text" class="form-control" name="room_number" id="room_number"  required>
                            <button type="button" class="btn btn-secondary" id="search_room">
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="search_spinner"></span>
                                <span id="search_text">Search</span>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="room_type" class="form-label">Room Type</label>
                        <input type="text" class="form-control" name="room_type" id="room_type" readonly required>
                    </div>
                </div>

                <!-- Dynamic Check Items Render Here -->
                <div id="check-items-wrapper"></div>

                <hr class="my-4">

                <!-- Submit Button -->
                <div class="text-center">
                    <div class="d-inline-flex gap-3">
                        <button type="submit" class="btn btn-secondary btn-lg px-5 mr-3">Submit</button>
                        <a href="{% url 'issue_create' %}" class="btn btn-secondary btn-lg px-4">Report New Issue</a>
                    </div>
                </div>
            </form>

<hr class="my-5">

<h4 class="mb-3">Previous Summary</h4>
<div class="row mb-4">
  <div class="col-12">
    <table class="table table-bordered table-striped" id="summary-table">
      <thead>
        <tr>
          <th>Room #</th>
          <th>Prework</th>
          <th>Product Arrival</th>
          <th>Retouching</th>
          <th>Product Installed</th>
          <th>Pending Products</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for summary in previous_summaries %}
        <tr>
          <td>{{ summary.room_number }}</td>
          <td>{{ summary.prework }}</td>
          <td>{{ summary.product_arrival }}</td>
          <td>{{ summary.retouching }}</td>
          <td>{{ summary.product_installed }}</td>
          <td>{{ summary.pending_products }}</td>
          <td>
            <button type="button" class="btn btn-secondary btn-sm edit-summary" data-room="{{ summary.room_number }}" data-roomtype="{{ summary.room_type }}">Edit</button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="text-center">No previous summaries found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <!-- Pagination controls -->
{% if is_paginated %}
<nav>
  <ul class="pagination justify-content-center">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
      </li>
    {% endif %}
    <li class="page-item disabled">
      <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
    </li>
    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
      </li>
    {% endif %}
  </ul>
</nav>
{% endif %}
  </div>
</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  $(document).ready(function () {
    $('#search_room').on('click', function () {
      const roomNumber = $('#room_number').val();
      if (!roomNumber) {
        toastr.error("Please enter a room number");
        return;
      }

      setLoading('search_room', true);
      $('#select_all_section').hide(); // Hide select all section while loading

      $.ajax({
        url: "{% url 'get_room_type' %}",
        type: "GET",
        data: { room_number: roomNumber },
        success: function (data) {
          console.log("Received data:", data);
          setLoading('search_room', false);
          if (data.success) {
            $('#room_type').val(data.room_type);
            renderCheckItems(data.check_items, data.saved_items);
          } else {
            toastr.error("Room number does not exist");
            $('#room_type').val('');
            $('#check-items-wrapper').html('');
          }
          
        },
        error: function () {
          toastr.error("Error fetching room type");
          setLoading('search_room', false);
          $('#room_type').val('');
          $('#check-items-wrapper').html('');
        }
      });
    });

    function renderCheckItems(items, savedItems = []) {
      const wrapper = $('#check-items-wrapper');
      wrapper.html('');

      // Show/hide select all section based on whether there are items
      if (items.length > 0) {
        $('#select_all_section').show();
      } else {
        $('#select_all_section').hide();
      }

      const savedItemsMap = {};
      savedItems.forEach(item => {
        if (item.install_id !== undefined) {

        console.log("item = ",item);
          savedItemsMap[`detail-${item.install_id}`] = item;
        }
      });

      items.forEach(item => {
        const key = `${item.type}-${item.id}`;
        const saved = savedItemsMap[key] || {};

        let isChecked = false;
        let installedBy = "";
        let installedOn = "";
        let product_client_id = "";
        if (item.type === "installation") {
          isChecked = item.status === "YES";
          installedBy = item.checked_by || "";
          installedOn = item.check_on ? item.check_on.split("T")[0] : "";
        } else if (item.type === "detail") {
          isChecked = saved.status === "YES";
          installedBy = saved.installed_by || "";
          installedOn = saved.installed_on ? saved.installed_on.split("T")[0] : "";
          product_client_id = saved.product_client_id ? saved.product_client_id : "";
        }

        const html = `
          <div class="form-group row align-items-center mb-3 border border-light rounded-top">
            <div class="col-md-5 mt-3">
              <div class="form-check mb-2">
                <input type="hidden" name="step_${item.type}_${item.id}" value="off">
            <input class="form-check-input"  type="checkbox" name="step_${item.type}_${item.id}" id="step_${item.type}_${item.id}" value="on" ${isChecked ? 'checked' : ''}>
            <input type="hidden" name="product_id_${item.type}_${item.id}" value="${product_client_id}">
                <label class="form-check-label" for="step_${item.type}_${item.id}">
                  ${item.label} 
                </label>
              </div>
            </div>
            <div class="col-md-3 mt-2 mb-2">
              <input type="date" readonly class="form-control" name="date_${item.type}_${item.id}" value="${installedOn}">
            </div>
            <div class="col-md-4 mt-2 mb-2">
              <input type="text" readonly class="form-control" name="checked_by_${item.type}_${item.id}" value="${installedBy}" placeholder="Checked by">
            </div>
          </div>
        `;
        wrapper.append(html);
      });
    }

    // Fill checked_by and check_on when checkbox is ticked
    $(document).on("change", ".form-check-input", function () {
      const checkbox = $(this);
      const idParts = checkbox.attr("id").split("_"); // ["step", "detail", "23"]
      const type = idParts[1];
      const id = idParts[2];

      const isChecked = checkbox.is(":checked");
      const currentDate = new Date().toISOString().split("T")[0];
      const currentUser = "{{ invited_user.name|escapejs }}";

      if (isChecked) {
        $(`input[name="date_${type}_${id}"]`).val(currentDate);
        $(`input[name="checked_by_${type}_${id}"]`).val(currentUser);
      } else {
        $(`input[name="date_${type}_${id}"]`).val("");
        $(`input[name="checked_by_${type}_${id}"]`).val("");
      }
    });

    // Toastr for Django messages
    {% if messages %}
    toastr.options = {
      "closeButton": true,
      "progressBar": true,
      "timeOut": "4000"
    };
    {% for message in messages %}
      {% if message.tags == "success" %}
        toastr.success("{{ message|escapejs }}");
      {% elif message.tags == "error" %}
        toastr.error("{{ message|escapejs }}");
      {% endif %}
    {% endfor %}
    {% endif %}
    
    // Handle edit button click in the previous summary table
    $('.edit-summary').on('click', function() {
      const roomNumber = $(this).data('room');
      
      // Set the room number in the search field
      $('#room_number').val(roomNumber);
      
      // Trigger the search button click to load room data
      $('#search_room').trigger('click');
      
      // Scroll to the top of the form for better UX
      $('html, body').animate({
        scrollTop: $("#room_number").offset().top - 100
      }, 500);
      
      // Visual feedback
      toastr.info(`Loading details for room ${roomNumber}...`);
    });
  });
</script>
{% endblock %}
