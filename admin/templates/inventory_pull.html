{% extends "frontend_base.html" %}
{% load static %}

{% block title %}Inventory Pull Form{% endblock %}

{% block content %}
<div class="container-lg my-5">
  <div class="card shadow-sm rounded-4 p-4">
    <h3 class="mb-4 text-center text-secondary py-4">Inventory Pull Form</h3>

    <form method="post">
      {% csrf_token %}

      <div class="row mb-4">
        <div class="col-md-6">
          <label class="form-label">Floor Number</label>
          <div class="input-group">
            <input type="text" class="form-control rounded-3" name="floor_number" id="floor_number" required>
            <button type="button" class="btn btn-secondary" id="search_floor">
              <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="search_spinner"></span>
              <span id="search_text">Search</span>
            </button>
          </div>
        </div>
      </div>

      <hr class="my-4">

      <!-- Dynamic Product List Render Here -->
      <div id="products-wrapper "></div>

      <hr class="my-4">

      <div class="text-center mt-4">
        <button type="submit" class="btn btn-secondary px-5 rounded-3 shadow-sm">Submit</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  $(document).ready(function () {
    const currentDate = new Date();
    const userName = "{{ user_name }}";
    const isoDate = currentDate.toISOString().split('T')[0];

    function renderProducts(products) {
      const wrapper = $('#products-wrapper');
      wrapper.html('');

      products.forEach(product => {
        const html = `
          <div class="form-group row align-items-center mb-3">
            <div class="col-md-4">
              <div class="form-check">
                <input type="hidden" name="product_${product.id}" value="off">
                <input class="form-check-input product-checkbox ms-2" type="checkbox" 
                       name="product_${product.id}" 
                       id="product_${product.id}" 
                       value="on"
                       data-available-qty="${product.available_qty}"
                       data-required-qty="${product.quantity}">
                <label class="form-check-label" for="product_${product.id}">
                  (${product.client_id}) - ${product.description}
                  <br>
                  <small class="text-muted">
                    Total Required: ${product.quantity}, 
                    Available: ${product.available_qty},
                    Already Pulled: ${product.pulled_quantity}
                  </small>
                </label>
              </div>
            </div>
            <div class="col-md-2">
              <input type="number" class="form-control qty-pulled" 
                     name="qty_pulled_${product.id}" 
                     min="1" 
                     max="${product.available_qty}"
                     value="${product.quantity}"
                     placeholder="Qty">
            </div>
            <div class="col-md-2">
              <input type="date" class="form-control pull-date" name="date_${product.id}" value="">
            </div>
            <div class="col-md-4">
              <input type="text" class="form-control pull-checked-by" name="checked_by_${product.id}" value="" placeholder="Checked by">
            </div>
          </div>
        `;
        wrapper.append(html);
      });

      // Add event listeners for checkboxes
      $('.product-checkbox').on('change', function() {
        const row = $(this).closest('.form-group');
        const dateInput = row.find('.pull-date');
        const checkedByInput = row.find('.pull-checked-by');
        const qtyInput = row.find('.qty-pulled');
        
        if ($(this).is(':checked')) {
          dateInput.val(isoDate);
          checkedByInput.val(userName);
          qtyInput.prop('disabled', false);
        } else {
          dateInput.val('');
          checkedByInput.val('');
          qtyInput.prop('disabled', true);
        }
      });

      // Initialize qty inputs as disabled
      $('.qty-pulled').prop('disabled', true);
    }

    $('#search_floor').on('click', function () {
      const floorNumber = $('#floor_number').val();
      if (!floorNumber) {
        toastr.error("Please enter a floor number");
        return;
      }

      setLoading('search_floor', true);

      $.ajax({
        url: "{% url 'get_floor_products' %}",
        type: "GET",
        data: { floor_number: floorNumber },
        success: function (data) {
          setLoading('search_floor', false);
          if (data.success) {
            renderProducts(data.products);
          } else {
            toastr.error(data.error || "Error fetching floor products");
          }
        },
        error: function () {
          setLoading('search_floor', false);
          toastr.error("Error fetching floor products");
        }
      });
    });

    {% if messages %}
    toastr.options = {
      "closeButton": true,
      "progressBar": true,
      "timeOut": "4000"
    };
    {% for message in messages %}
      {% if message.tags == "success" %}
        toastr.success("{{ message|escapejs }}");
      {% elif message.tags == "error" %}
        toastr.error("{{ message|escapejs }}");
      {% endif %}
    {% endfor %}
    {% endif %}
  });
</script>
{% endblock %}
