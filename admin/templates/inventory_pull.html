{% extends "frontend_base.html" %}
{% load static %}

{% block title %}Inventory Pull Form{% endblock %}

{% block content %}
<style>
  @media (max-width: 768px) {
    input[type='checkbox'] {
      width: 25px;
      height: 25px;
    }
    .form-label{
      font-size: 16px;
    }
    .fw-bold{
      font-size: 16px;
    }
    .container-lg {
      padding-left: 5px;
      padding-right: 5px;
    }
    .card-body {
      padding: 10px 5px;
    }
    h3 {
      font-size: 20px;
    }
    h4 {
      font-size: 18px;
    }
    
    /* Table optimizations for mobile */
    .table-responsive {
      overflow-x: auto;
    }
    .table {
      font-size: 12px;
    }
    .table th, .table td {
      padding: 5px;
    }
    .table input {
      padding: 4px;
      font-size: 13px;
      height: 32px;
    }
    
    /* Button optimizations for mobile */
    .btn {
      padding: 6px 10px;
      font-size: 14px;
      margin-bottom: 8px;
      height: auto;
      white-space: normal;
    }
    .btn-lg {
      padding: 8px 12px;
      font-size: 14px;
    }
    
    /* Stack buttons on mobile */
    .text-center .gap-3 {
      flex-direction: column;
      width: 100%;
    }
    .text-center .gap-3 .btn, 
    .text-center .gap-3 a.btn {
      width: 100%;
      margin-bottom: 10px;
      margin-right: 0 !important;
      margin-left: 0 !important;
    }
  }

  /* General responsive improvements */
  .table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  input.form-control, select.form-control {
    height: 38px;
    font-size: 16px; /* Prevents iOS zoom on focus */
  }

  /* Tab styling */
  .nav-tabs .nav-link {
    color: #6c757d;
    border: 1px solid transparent;
    border-top-left-radius: 0.25rem;
    border-top-right-radius: 0.25rem;
    padding: 0.5rem 1rem;
    font-size: 1rem;
  }
  
  .nav-tabs .nav-link.active {
    color: #495057;
    background-color: #fff;
    border-color: #dee2e6 #dee2e6 #fff;
    font-weight: 500;
  }
</style>

<div class="container-lg my-5">
  <div class="card shadow-sm rounded-4">
    <div class="card-body p-4">
      <h3 class="mb-4 text-center text-secondary py-4">Inventory Pull Form</h3>
    
      <form method="post">
        {% csrf_token %}

        <div class="row mb-4">
          <div class="col-md-6">
            <label class="form-label">Floor Number</label>
            <div class="input-group">
              <input type="text" class="form-control rounded-3" name="floor_number" id="floor_number" required>
              <button type="button" class="btn btn-secondary" id="search_floor">
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="search_spinner"></span>
                <span id="search_text">Search</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Common date and checked by fields -->
        <div class="row mb-4" id="common-fields">
          <div class="col-md-6">
            <label class="form-label">Date</label>
            <input type="date" class="form-control" id="common-date" name="common_date" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label">Checked By</label>
            <input type="text" class="form-control" id="common-checked-by" name="common_checked_by" value="{{ user_name }}" readonly>
          </div>
        </div>

        <hr class="my-4">

        <!-- Tabs navigation -->
        <ul class="nav nav-tabs mb-4" id="pullTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="requested-tab" data-bs-toggle="tab" data-bs-target="#requested" 
                    type="button" role="tab" aria-controls="requested" aria-selected="true">Requested</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="received-tab" data-bs-toggle="tab" data-bs-target="#received" 
                    type="button" role="tab" aria-controls="received" aria-selected="false">Received</button>
          </li>
        </ul>

        <!-- Tab content -->
        <div class="tab-content" id="pullTabContent">
          <div class="tab-pane fade show active" id="requested" role="tabpanel" aria-labelledby="requested-tab">
            <!-- Dynamic Product List Render Here -->
            <div id="products-wrapper"></div>
          </div>
          <div class="tab-pane fade" id="received" role="tabpanel" aria-labelledby="received-tab">
            <!-- This will contain the same content but with different editability -->
            <div id="products-wrapper-received"></div>
          </div>
        </div>

        <hr class="my-4">

        <div class="text-center mt-4">
          <div class="d-inline-flex gap-3">
            <button type="button" class="btn btn-outline-secondary mr-3" id="clear-form-btn">Cancel / Clear Form</button>
            <button type="submit" class="btn btn-secondary btn-lg px-5 rounded-3 shadow-sm mr-3">Submit</button>
            <a href="{% url 'issue_create' %}" class="btn btn-secondary btn-lg px-4 rounded-3 shadow-sm">Report New Issue</a>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Make sure Bootstrap JS is included for tabs -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  $(document).ready(function () {
    const currentDate = new Date();
    const userName = "{{ user_name }}";
    const isoDate = currentDate.toISOString().split('T')[0];
    
    // Set the common date field
    $('#common-date').val(isoDate);
    
    // Hide common fields initially until products are loaded
    $('#common-fields').hide();

    function renderProducts(products) {
      // Show common fields when products are loaded
      $('#common-fields').show();
      
      // Clear both wrappers
      const requestedWrapper = $('#products-wrapper');
      const receivedWrapper = $('#products-wrapper-received');
      requestedWrapper.html('');
      receivedWrapper.html('');
      
      products.forEach(product => {
        // Create template for requested tab
        const requestedHtml = `
          <div class="form-group row align-items-center mb-3 product-row" data-product-id="${product.id}">
            <div class="col-md-4">
              <div class="form-check">
                <input type="hidden" name="product_${product.id}" value="off">
                <input class="form-check-input product-checkbox ms-2" type="checkbox" 
                       name="product_${product.id}" 
                       id="product_${product.id}" 
                       data-product-id="${product.id}"
                       data-available-qty="${product.available_qty}"
                       data-required-qty="${product.quantity}"
                       value="on">
                <label class="form-check-label" for="product_${product.id}">
                  (${product.client_id}) - ${product.description}
                  <br>
                  <small class="text-muted">
                    Required: ${product.quantity}, 
                    Available: ${product.available_qty},
                    Already Pulled: ${product.pulled_quantity}
                  </small>
                </label>
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Requested</label>
              <input type="number" class="form-control requested-qty" 
                     name="requested_qty_${product.id}" 
                     min="1" 
                     max="${Math.min(product.available_qty, product.quantity)}"
                     value="${Math.min(product.available_qty, product.quantity)}"
                     data-product-id="${product.id}"
                     placeholder="Requested Qty">
              <small class="text-danger requested-error-${product.id}" style="display: none;">
                Cannot exceed available/required quantity
              </small>
            </div>
            <div class="col-md-4">
              <label class="form-label">Received</label>
              <input type="number" class="form-control received-qty" 
                     name="received_qty_${product.id}" 
                     min="0" 
                     max="${Math.min(product.available_qty, product.quantity)}"
                     value="0"
                     data-product-id="${product.id}"
                     placeholder="Received Qty"
                     disabled>
              <small class="text-danger received-error-${product.id}" style="display: none;">
                Cannot exceed requested quantity
              </small>
            </div>
          </div>
        `;
        
        // Create template for received tab
        const receivedHtml = `
          <div class="form-group row align-items-center mb-3 product-row" data-product-id="${product.id}">
            <div class="col-md-4">
              <div class="form-check">
                <input class="form-check-input product-checkbox-received ms-2" type="checkbox" 
                       name="product_received_${product.id}" 
                       id="product_received_${product.id}"
                       data-product-id="${product.id}"
                       value="on">
                <label class="form-check-label" for="product_received_${product.id}">
                  (${product.client_id}) - ${product.description}
                  <br>
                  <small class="text-muted">
                    Required: ${product.quantity}, 
                    Available: ${product.available_qty},
                    Already Pulled: ${product.pulled_quantity}
                  </small>
                </label>
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Requested</label>
              <input type="number" class="form-control requested-qty-readonly" 
                     name="requested_qty_ro_${product.id}" 
                     value="${Math.min(product.available_qty, product.quantity)}"
                     data-product-id="${product.id}"
                     readonly>
            </div>
            <div class="col-md-4">
              <label class="form-label">Received</label>
              <input type="number" class="form-control received-qty-edit" 
                     name="received_qty_${product.id}" 
                     min="0" 
                     max="${Math.min(product.available_qty, product.quantity)}"
                     value="0"
                     data-product-id="${product.id}"
                     placeholder="Received Qty"
                     disabled>
              <small class="text-danger received-edit-error-${product.id}" style="display: none;">
                Cannot exceed requested quantity
              </small>
            </div>
          </div>
        `;
        
        requestedWrapper.append(requestedHtml);
        receivedWrapper.append(receivedHtml);
      });

      // Add event listeners for checkboxes in requested tab
      $('.product-checkbox').on('change', function() {
        const productId = $(this).data('product-id');
        const row = $(this).closest('.product-row');
        const requestedInput = row.find('.requested-qty');
        const receivedInput = row.find('.received-qty');
        
        if ($(this).is(':checked')) {
          requestedInput.prop('disabled', false);
          
          // Also check the same product in received tab, but don't enable editing yet
          $(`#product_received_${productId}`).prop('checked', true);
        } else {
          requestedInput.prop('disabled', true);
          receivedInput.prop('disabled', true);
          
          // Uncheck in received tab too
          $(`#product_received_${productId}`).prop('checked', false);
          $(`[name="received_qty_${productId}"]`).prop('disabled', true);
        }
      });
      
      // Add event listeners for checkboxes in received tab
      $('.product-checkbox-received').on('change', function() {
        const productId = $(this).data('product-id');
        const receivedInput = $(this).closest('.product-row').find('.received-qty-edit');
        
        if ($(this).is(':checked')) {
          receivedInput.prop('disabled', false);
          
          // Ensure the requested tab checkbox is also checked
          $(`#product_${productId}`).prop('checked', true);
        } else {
          receivedInput.prop('disabled', true);
          
          // Don't uncheck the requested tab since it might be needed
        }
      });
      
      // Add validation for requested quantities
      $('.requested-qty').on('input', function() {
        const productId = $(this).data('product-id');
        const productRow = $(this).closest('.product-row');
        const availableQty = parseInt(productRow.find('.product-checkbox').data('available-qty'));
        const requiredQty = parseInt(productRow.find('.product-checkbox').data('required-qty'));
        const maxQty = Math.min(availableQty, requiredQty);
        const requestedValue = parseInt($(this).val()) || 0;
        
        // Update max attribute in case it was changed dynamically
        $(this).attr('max', maxQty);
        
        // Validate and show error message
        if (requestedValue > maxQty) {
          $(this).val(maxQty);
          $(`.requested-error-${productId}`).show().fadeOut(3000);
        }
        
        // Update the received tabs's requested readonly field
        $(`[name="requested_qty_ro_${productId}"]`).val($(this).val());
        
        // Update the max value for the received quantity fields
        $(`[name="received_qty_${productId}"]`).attr('max', $(this).val());
      });
      
      // Add validation for received quantities
      $('.received-qty, .received-qty-edit').on('input', function() {
        const productId = $(this).data('product-id');
        const requestedQty = parseInt($(`[name="requested_qty_${productId}"]`).val()) || 
                             parseInt($(`[name="requested_qty_ro_${productId}"]`).val()) || 0;
        const receivedValue = parseInt($(this).val()) || 0;
        
        // Update max attribute
        $(this).attr('max', requestedQty);
        
        // Validate and show error message
        if (receivedValue > requestedQty) {
          $(this).val(requestedQty);
          $(`.received-error-${productId}, .received-edit-error-${productId}`).show().fadeOut(3000);
        }
        
        // Sync the value between tabs
        const otherInput = $(this).hasClass('received-qty') ? 
                           $(`.received-qty-edit[data-product-id="${productId}"]`) : 
                           $(`.received-qty[data-product-id="${productId}"]`);
        otherInput.val($(this).val());
      });
      
      // Initially disable all quantity inputs
      $('.requested-qty, .received-qty, .received-qty-edit').prop('disabled', true);
    }

    // Make sure all received quantities are properly collected on form submission
    $('form').on('submit', function(e) {
      // Prevent default submission
      e.preventDefault();
      
      // Create hidden fields for the actual form submission
      const productsWrapper = $('#products-wrapper');
      const hiddenFields = [];
      
      // Check if there are any products selected
      let hasSelectedProducts = false;
      
      $('.product-checkbox:checked').each(function() {
        hasSelectedProducts = true;
        const productId = $(this).data('product-id');
        const requestedQty = $(`[name="requested_qty_${productId}"]`).val();
        const receivedQty = $(`[name="received_qty_${productId}"]`).val();
        const pulledBefore = $(this).closest('.product-row').find('.text-muted').text().match(/Already Pulled: (\d+)/)[1];
        
        // Store product IDs and quantities
        hiddenFields.push(`<input type="hidden" name="selected_product_ids" value="${productId}">`);
        hiddenFields.push(`<input type="hidden" name="requested_quantities" value="${requestedQty}">`);
        hiddenFields.push(`<input type="hidden" name="received_quantities" value="${receivedQty}">`);
        hiddenFields.push(`<input type="hidden" name="previous_pulled_quantities" value="${pulledBefore}">`);
      });
      
      if (!hasSelectedProducts) {
        toastr.error("Please select at least one product");
        return false;
      }
      
      // Add the common fields
      hiddenFields.push(`<input type="hidden" name="common_date" value="${$('#common-date').val()}">`);
      hiddenFields.push(`<input type="hidden" name="common_checked_by" value="${$('#common-checked-by').val()}">`);
      hiddenFields.push(`<input type="hidden" name="floor_number" value="${$('#floor_number').val()}">`);
      
      // Append all hidden fields
      productsWrapper.append(hiddenFields.join(''));
      
      // Submit the form
      this.submit();
    });

    // Switch tab handling
    $('#pullTabs button').on('click', function (e) {
      e.preventDefault();
      $(this).tab('show');
    });

    // Clear form functionality
    $('#clear-form-btn').on('click', function() {
      $('#floor_number').val('');
      $('#products-wrapper, #products-wrapper-received').html('');
      $('#common-fields').hide();
    });
    
    // Function to handle loading state
    function setLoading(action, isLoading) {
      if (action === 'search_floor') {
        if (isLoading) {
          $('#search_spinner').removeClass('d-none');
          $('#search_text').text('Searching...');
          $('#search_floor').prop('disabled', true);
        } else {
          $('#search_spinner').addClass('d-none');
          $('#search_text').text('Search');
          $('#search_floor').prop('disabled', false);
        }
      }
    }

    $('#search_floor').on('click', function () {
      const floorNumber = $('#floor_number').val();
      if (!floorNumber) {
        toastr.error("Please enter a floor number");
        return;
      }

      setLoading('search_floor', true);

      $.ajax({
        url: "{% url 'get_floor_products' %}",
        type: "GET",
        data: { floor_number: floorNumber },
        success: function (data) {
          setLoading('search_floor', false);
          if (data.success) {
            renderProducts(data.products);
          } else {
            toastr.error(data.error || "Error fetching floor products");
          }
        },
        error: function () {
          setLoading('search_floor', false);
          toastr.error("Error fetching floor products");
        }
      });
    });

    {% if messages %}
    toastr.options = {
      "closeButton": true,
      "progressBar": true,
      "timeOut": "4000"
    };
    {% for message in messages %}
      {% if message.tags == "success" %}
        toastr.success("{{ message|escapejs }}");
      {% elif message.tags == "error" %}
        toastr.error("{{ message|escapejs }}");
      {% endif %}
    {% endfor %}
    {% endif %}
  });
</script>
{% endblock %}