{% extends "frontend_base.html" %}
{% load static %}

{% block title %}Hotel Warehouse{% endblock %}

{% block content %}
<style>
  @media (max-width: 768px) {
    input[type='checkbox'] {
      width: 25px;
      height: 25px;
    }
    .form-label{
      font-size: 16px;
    }
    .fw-bold{
      font-size: 16px;
    }
    .container-lg {
      padding-left: 5px;
      padding-right: 5px;
    }
    .card-body {
      padding: 10px 5px;
    }
    h3 {
      font-size: 20px;
    }
    h4 {
      font-size: 18px;
    }
    
    /* Table optimizations for mobile */
    .table-responsive {
      overflow-x: auto;
    }
    .table {
      font-size: 12px;
    }
    .table th, .table td {
      padding: 5px;
    }
    .table input {
      padding: 4px;
      font-size: 13px;
      height: 32px;
    }
    
    /* Button optimizations for mobile */
    .btn {
      padding: 6px 10px;
      font-size: 14px;
      margin-bottom: 8px;
      height: auto;
      white-space: normal;
    }
    .btn-lg {
      padding: 8px 12px;
      font-size: 14px;
    }
    
    /* Stack buttons on mobile */
    .text-center .gap-3 {
      flex-direction: column;
      width: 100%;
    }
    .text-center .gap-3 .btn, 
    .text-center .gap-3 a.btn {
      width: 100%;
      margin-bottom: 10px;
      margin-right: 0 !important;
      margin-left: 0 !important;
    }
  }

  /* General responsive improvements */
  .table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  input.form-control, select.form-control {
    height: 38px;
    font-size: 16px; /* Prevents iOS zoom on focus */
  }
  
  .yes-badge {
    background-color: #28a745;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
  }
  
  .no-badge {
    background-color: #dc3545;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
  }
  
  .pending-request {
    background-color: #fff3cd !important;
  }
  
  .sent-qty-input {
    max-width: 80px;
  }
</style>

<div class="container-lg my-5">
  <div class="card shadow-sm rounded-4">
    <div class="card-body p-4">
      <h3 class="mb-2 text-center text-secondary py-4">Warehouse</h3>
      <h4 class="mb-4 text-secondary">Pending Requests</h4>
      <p class="text-muted mb-4">Showing only requests that haven't been fully sent yet.</p>
      
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="input-group">
            <input type="text" class="form-control" placeholder="Search by floor number" id="search-input">
            <button class="btn btn-secondary" type="button" id="search-button">Search</button>
          </div>
        </div>
        <div class="col-md-6 text-md-end mt-3 mt-md-0">
          <button class="btn btn-outline-secondary" id="refresh-button">
            <i class="material-icons align-middle">refresh</i> Refresh
          </button>
        </div>
      </div>
      
      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>Floor Number</th>
              <th>Requested By</th>
              <th>Items</th>
              <th>Requested Qty</th>
              <th>Sent Qty</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="requests-table">
            {% for request in warehouse_requests %}
            <tr class="pending-request">
              <td>{{ request.floor_number }}</td>
              <td>{{ request.requested_by }}</td>
              <td>{{ request.item_count }}</td>
              <td>{{ request.quantity_requested }}</td>
              <td>
                <input type="number" class="form-control sent-qty-input" 
                       data-floor="{{ request.floor_number }}" 
                       value="{{ request.quantity_received }}" 
                       min="0" 
                       max="{{ request.quantity_requested }}">
              </td>
              <td>
                <button type="button" class="btn btn-primary btn-sm view-details" data-id="{{ request.id }}" data-floor="{{ request.floor_number }}">View Details</button>
                <button type="button" class="btn btn-success btn-sm update-sent-qty" data-floor="{{ request.floor_number }}">Update Sent</button>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center">No pending requests found</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      {% if is_paginated %}
      <nav>
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
          </li>
          {% endif %}
          <li class="page-item disabled">
            <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
          </li>
          {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
          </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
    </div>
  </div>
</div>

<!-- Request Details Modal -->
<div class="modal fade" id="requestDetailsModal" tabindex="-1" aria-labelledby="requestDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="requestDetailsModalLabel">Pending Request Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <p><strong>Floor Number:</strong> <span id="modal-floor"></span></p>
            <p><strong>Requested By:</strong> <span id="modal-requester"></span></p>
            <p><strong>Requested Date:</strong> <span id="modal-date"></span></p>
          </div>
          <div class="col-md-6">
            <p><strong>Status:</strong> <span id="modal-status"></span></p>
            <p><strong>Total Items:</strong> <span id="modal-items"></span></p>
          </div>
        </div>
        
        <h6 class="mt-4 mb-3">Pending Items</h6>
        <div class="table-responsive">
          <table class="table table-sm table-bordered">
            <thead>
              <tr>
                <th>Item #</th>
                <th>Description</th>
                <th>Requested Qty</th>
                <th>Sent Qty</th>
              </tr>
            </thead>
            <tbody id="modal-items-list">
              <!-- Items will be populated dynamically -->
            </tbody>
          </table>
        </div>
        
        <div class="row mt-4">
          <div class="col-md-6">
            <div class="form-group">
              <label for="modal-total-sent" class="form-label">Total Sent Quantity:</label>
              <input type="number" id="modal-total-sent" class="form-control" min="0">
              <small class="form-text text-muted">This will be distributed proportionally across all items.</small>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-success" id="modal-mark-sent" style="display: none;">Mark as Sent</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  $(document).ready(function() {
    // View details button click
    $('.view-details').on('click', function() {
      const requestId = $(this).data('id');
      const floorNumber = $(this).data('floor');
      
      // Get data from the row
      const requestedBy = $(this).closest('tr').find('td:eq(1)').text();
      const itemCount = $(this).closest('tr').find('td:eq(2)').text();
      const requestedQty = $(this).closest('tr').find('td:eq(3)').text();
      const receivedQty = $(this).closest('tr').find('td:eq(4) input').val();
      
      // Populate the modal
      $('#modal-floor').text(floorNumber);
      $('#modal-requester').text(requestedBy);
      $('#modal-date').text(''); // We don't have a date in the current implementation
      $('#modal-status').text('Pending');
      $('#modal-items').text(itemCount);
      
      // Always show mark as sent button since we're only displaying pending requests
      $('#modal-mark-sent').show();
      $('#modal-mark-sent').data('floor', floorNumber);
      
      // Fetch the actual items for this floor from the server
      $.ajax({
        url: "{% url 'warehouse_request_items' %}",
        type: 'GET',
        data: { floor_number: floorNumber },
        success: function(response) {
          if (response.success) {
            // Populate items table with real data
            const itemsList = $('#modal-items-list');
            itemsList.empty();
            
            let totalRequested = 0;
            let totalReceived = 0;
            
            response.items.forEach(item => {
              totalRequested += parseInt(item.quantity_requested) || 0;
              totalReceived += parseInt(item.quantity_received) || 0;
              
              itemsList.append(`
                <tr data-client-item="${item.client_item}" data-requested="${item.quantity_requested}">
                  <td>${item.client_item}</td>
                  <td>${item.product_name || 'Unknown'}</td>
                  <td>${item.quantity_requested}</td>
                  <td class="item-received-qty">${item.quantity_received}</td>
                </tr>
              `);
            });
            
            // Set the total sent quantity input value
            $('#modal-total-sent').val(totalReceived);
            
            // Add event listener for the total sent quantity input
            $('#modal-total-sent').off('change').on('change', function() {
              const totalSent = parseInt($(this).val()) || 0;
              
              // Distribute proportionally
              if (totalRequested > 0 && totalSent > 0) {
                response.items.forEach(item => {
                  const proportion = item.quantity_requested / totalRequested;
                  const itemSent = Math.round(totalSent * proportion);
                  
                  // Update the table cell
                  $(`tr[data-client-item="${item.client_item}"] .item-received-qty`).text(itemSent);
                });
              } else {
                // If total is 0, set all to 0
                $('.item-received-qty').text('0');
              }
            });
          } else {
            // If API fails, show placeholder data
            const itemsList = $('#modal-items-list');
            itemsList.empty();
            
            // Create a single row with a message
            itemsList.append(`
              <tr>
                <td colspan="4" class="text-center">Could not load item details</td>
              </tr>
            `);
          }
        },
        error: function() {
          // If AJAX fails, show placeholder data
          const itemsList = $('#modal-items-list');
          itemsList.empty();
          
          // Create a single row with a message
          itemsList.append(`
            <tr>
              <td colspan="4" class="text-center">Could not load item details</td>
            </tr>
          `);
        }
      });
      
      // Show the modal
      $('#requestDetailsModal').modal('show');
    });
    
    // Mark as sent button click (in modal)
    $('#modal-mark-sent').on('click', function() {
      const floorNumber = $(this).data('floor');
      
      // Get the total sent quantity from the modal input
      const sentQty = $('#modal-total-sent').val();
      
      // Create a form and submit it to perform the server-side action
      const form = $('<form method="post"></form>');
      form.append(`<input type="hidden" name="csrfmiddlewaretoken" value="${$('input[name=csrfmiddlewaretoken]').val()}">`);
      form.append(`<input type="hidden" name="action" value="update_sent_qty">`);
      form.append(`<input type="hidden" name="floor_number" value="${floorNumber}">`);
      form.append(`<input type="hidden" name="sent_qty" value="${sentQty}">`);
      
      // Append to body, submit, and remove
      $('body').append(form);
      form.submit();
      form.remove();
      
      // Close the modal
      $('#requestDetailsModal').modal('hide');
    });
    
    // Update sent quantity button click (in table)
    $('.update-sent-qty').on('click', function() {
      const floorNumber = $(this).data('floor');
      const sentQtyInput = $(`.sent-qty-input[data-floor="${floorNumber}"]`);
      const sentQty = sentQtyInput.val();
      
      // Create a form and submit it to perform the server-side action
      const form = $('<form method="post"></form>');
      form.append(`<input type="hidden" name="csrfmiddlewaretoken" value="${$('input[name=csrfmiddlewaretoken]').val()}">`);
      form.append(`<input type="hidden" name="action" value="update_sent_qty">`);
      form.append(`<input type="hidden" name="floor_number" value="${floorNumber}">`);
      form.append(`<input type="hidden" name="sent_qty" value="${sentQty}">`);
      
      // Append to body, submit, and remove
      $('body').append(form);
      form.submit();
      form.remove();
    });
    
    // Search functionality
    $('#search-button').on('click', function() {
      const searchTerm = $('#search-input').val().trim().toLowerCase();
      
      if (searchTerm === '') {
        // If search is empty, show all rows
        $('#requests-table tr').show();
        return;
      }
      
      // Hide rows that don't match the search term
      $('#requests-table tr').each(function() {
        const floorNumber = $(this).find('td:eq(0)').text().toLowerCase();
        if (floorNumber.includes(searchTerm)) {
          $(this).show();
        } else {
          $(this).hide();
        }
      });
    });
    
    // Refresh button click
    $('#refresh-button').on('click', function() {
      // In a real implementation, you would reload the data from the server
      // For now, we'll just reset the search and show all rows
      $('#search-input').val('');
      $('#requests-table tr').show();
      toastr.info('Data refreshed');
    });
    
    // Initialize toastr options
    toastr.options = {
      "closeButton": true,
      "progressBar": true,
      "timeOut": "3000"
    };
  });
</script>
{% endblock %} 