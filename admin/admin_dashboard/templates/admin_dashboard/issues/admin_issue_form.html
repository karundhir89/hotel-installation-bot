{% extends 'admin_dashboard/dashboard_layout.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Admin - Edit Issue #{{ issue.id|default:"Unknown" }}{% endblock %}

{% block content %}
<style>
    .primary{
        background-color: #5a6268;
        &:hover{
            background-color: #5a6268;
        }
    }
    .left{
        text-align: left;
    }
    .selected {
        background-color: #5a6268;
    }

    /* Observer Modal Styles */
    .observer-list {
        max-height: 200px;
        overflow-y: auto;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
        margin-bottom: 15px;
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
    }
    .observer-item {
        padding: 5px 10px;
        margin-bottom: 5px;
        background-color: #fff;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }
    .observer-search {
        margin-bottom: 15px;
    }
    .modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }
    .user-checkbox {
        margin-right: 10px;
    }
    .user-item {
        padding: 8px;
        border-bottom: 1px solid #dee2e6;
    }
    .user-item:hover {
        background-color: #f8f9fa;
    }
    .user-item:last-child {
        border-bottom: none;
    }
    .selected-users {
        margin-top: 10px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
    .selected-user {
        display: inline-block;
        padding: 5px 10px;
        margin: 2px;
        background-color: #e9ecef;
        border-radius: 15px;
        font-size: 0.9em;
    }
    .selected-user .remove-user {
        margin-left: 5px;
        cursor: pointer;
        color: #dc3545;
    }
</style>
<div class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header card-header-primary d-flex justify-content-between">
                        <h4 class="card-title pt-2 text-dark">Issue: {{ issue.title|default:"Untitled"|title }}</h4>
                    </div>
                    <div class="card-body">
                        <p class="text-dark left">Created by: {{ issue.created_by }} </p>
                        <p class="text-dark left">Created on: {{ issue.created_at|date:"F d, Y" }}</p>
                        {% include 'common/messages.html' %}
                        
                        <form method="post" id="issueForm">
                            {% csrf_token %}
                            
                            {# Render all fields except observers #}
                            {% for field in form %}
                                {% if field.name != 'observers' %}
                                    {{ field|as_crispy_field }}
                                {% endif %}
                            {% endfor %}

                            {# Custom layout for observers #}
                            <div class="form-group">
                                <label for="id_observers">Observers</label>
                                <div style="display: flex; justify-content: space-between;">
                                    <div class="observer-list">
                                        {% for observer in observers %}
                                            <div class="observer-item" data-user-id="{{ observer.id }}">
                                                {{ observer.name }}
                                            </div>
                                        {% empty %}
                                            <p class="text-muted">No observers selected</p>
                                        {% endfor %}
                                    </div>
                                    <div>
                                        <button type="button" class="btn primary" data-bs-toggle="modal" data-bs-target="#observersModal">
                                            Edit Observers
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn primary mt-3">Save Changes</button>
                            <a href="{% url 'admin_dashboard:admin_issue_list' %}" class="btn btn-secondary mt-3">Cancel</a>
                            {% if issue.id %}
                            <a href="{% url 'admin_dashboard:admin_issue_detail' issue.id %}" class="btn btn-sm edit-button ">View</a>
                            {% else %}
                                <a href="#" class="btn btn-info mt-3 disabled" aria-disabled="true">View Issue Details</a>
                            {% endif %}
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Observers Modal -->
<div class="modal fade" id="observersModal" tabindex="-1" aria-labelledby="observersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="observersModalLabel">Edit Observers</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="observer-search">
                    <input type="text" class="form-control" id="userSearch" placeholder="Search users...">
                </div>
                <div class="selected-users" id="selectedUsers">
                    <!-- Selected users will be displayed here -->
                </div>
                <div class="user-list" id="userList">
                    {% for user in available_users %}
                        <div class="user-item" style="display: flex; align-items: center;">
                            <input type="checkbox" class="user-checkbox" id="user_{{ user.id }}" 
                                   value="{{ user.id }}" data-user-name="{{ user.name }}"
                                   {% if user in observers %}checked{% endif %}>
                            <label for="user_{{ user.id }}">{{ user.name }}</label>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn primary" id="saveObservers">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const userSearch = document.getElementById('userSearch');
    const userList = document.getElementById('userList');
    const selectedUsers = document.getElementById('selectedUsers');
    const saveObserversBtn = document.getElementById('saveObservers');
    const observerList = document.querySelector('.observer-list');
    
    // Create multiple hidden inputs for observers
    function createObserverInputs(selectedIds) {
        // Remove existing observer inputs
        document.querySelectorAll('input[name="observers"]').forEach(input => input.remove());
        
        // Create new inputs for each selected observer
        selectedIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'observers';
            input.value = id;
            document.getElementById('issueForm').appendChild(input);
        });
    }

    // Initialize selected users display
    function updateSelectedUsers() {
        const selected = Array.from(document.querySelectorAll('.user-checkbox:checked'));
        selectedUsers.innerHTML = selected.map(checkbox => `
            <span class="selected-user" data-user-id="${checkbox.value}">
                ${checkbox.dataset.userName}
                <span class="remove-user" onclick="removeUser(${checkbox.value})">&times;</span>
            </span>
        `).join('');
    }

    // Search functionality
    userSearch.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const userItems = userList.getElementsByClassName('user-item');
        
        Array.from(userItems).forEach(item => {
            const userName = item.querySelector('label').textContent.toLowerCase();
            item.style.display = userName.includes(searchTerm) ? '' : 'none';
        });
    });

    // Handle checkbox changes
    userList.addEventListener('change', function(e) {
        if (e.target.classList.contains('user-checkbox')) {
            updateSelectedUsers();
        }
    });

    // Remove user function
    window.removeUser = function(userId) {
        const checkbox = document.querySelector(`#user_${userId}`);
        if (checkbox) {
            checkbox.checked = false;
            updateSelectedUsers();
        }
    };

    // Save observers
    saveObserversBtn.addEventListener('click', function() {
        const selected = Array.from(document.querySelectorAll('.user-checkbox:checked'));
        const selectedIds = selected.map(checkbox => checkbox.value);
        
        // Update hidden inputs
        createObserverInputs(selectedIds);
        
        // Update observer list display
        observerList.innerHTML = selected.map(checkbox => `
            <div class="observer-item" data-user-id="${checkbox.value}">
                ${checkbox.dataset.userName}
            </div>
        `).join('') || '<p class="text-muted">No observers selected</p>';
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('observersModal'));
        modal.hide();
    });

    // Initialize selected users display
    updateSelectedUsers();
});
</script>
{% endblock %}